default_platform(:ios)

def load_app_store_api_credentials!
  raw_key = ENV.fetch("APP_STORE_CONNECT_API_KEY_CONTENT").strip

  key_content =
    if raw_key.include?("BEGIN PRIVATE KEY")
      raw_key.gsub("\\n", "\n")
    else
      require "base64"
      Base64.strict_decode64(raw_key)
    end

  require "tmpdir"
  key_id = ENV.fetch("APP_STORE_CONNECT_KEY_ID")
  issuer_id = ENV.fetch("APP_STORE_CONNECT_ISSUER_ID")
  key_path = File.join(Dir.tmpdir, "AuthKey_#{key_id}.p8")
  File.write(key_path, key_content)

  api_key = app_store_connect_api_key(
    key_id: ENV.fetch("APP_STORE_CONNECT_KEY_ID"),
    issuer_id: issuer_id,
    key_content: key_content,
    is_key_content_base64: false
  )
  [api_key, key_path, key_id, issuer_id]
rescue ArgumentError
  UI.user_error!("APP_STORE_CONNECT_API_KEY_CONTENT must be a .p8 private key text (or base64-encoded .p8 text)")
end

platform :ios do
  desc "Build iOS and upload to TestFlight"
  lane :beta do |options|
    api_key, auth_key_path, auth_key_id, auth_issuer_id = load_app_store_api_credentials!
    team_id = ENV.fetch("APPLE_TEAM_ID", ENV.fetch("APP_STORE_CONNECT_TEAM_ID"))

    if ENV["MATCH_GIT_URL"] && !ENV["MATCH_GIT_URL"].empty?
      match(
        type: "appstore",
        readonly: ENV.fetch("MATCH_READONLY", "true") == "true",
        app_identifier: ENV.fetch("IOS_APP_IDENTIFIER", "com.pecal.mobile")
      )
    end

    build_number = ENV["IOS_BUILD_NUMBER"]
    increment_build_number(
      xcodeproj: "ios/PecalMobile.xcodeproj",
      build_number: build_number
    ) if build_number && !build_number.empty?

    build_app(
      workspace: "ios/PecalMobile.xcworkspace",
      scheme: "PecalMobile",
      configuration: "Release",
      clean: true,
      export_method: "app-store",
      export_options: {
        signingStyle: "automatic",
        teamID: team_id
      },
      xcargs: [
        "CODE_SIGN_STYLE=Automatic",
        "DEVELOPMENT_TEAM=#{team_id}",
        "-allowProvisioningUpdates",
        "-authenticationKeyPath #{auth_key_path}",
        "-authenticationKeyID #{auth_key_id}",
        "-authenticationKeyIssuerID #{auth_issuer_id}"
      ].join(" "),
      output_directory: "build/ios",
      output_name: "PecalMobile.ipa"
    )

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      changelog: (options[:changelog] || ENV["CHANGELOG"]),
      distribute_external: false
    )
  end

  desc "Submit latest build to App Store review"
  lane :release do
    api_key, = load_app_store_api_credentials!

    upload_to_app_store(
      api_key: api_key,
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: true,
      automatic_release: false,
      precheck_include_in_app_purchases: false
    )
  end
end
