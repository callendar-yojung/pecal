name: Web Build & Deploy

on:
  push:
    branches: ["main"]
    paths:
      - "apps/web/**"
  workflow_dispatch:

concurrency:
  group: web-deploy-main
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      # Deploy target
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SSH_USER: callendar
      DEPLOY_PATH: /home/callendar/apps/api

      # NextAuth
      AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

      # Kakao OAuth
      AUTH_KAKAO_ID: ${{ secrets.AUTH_KAKAO_ID }}
      AUTH_KAKAO_SECRET: ${{ secrets.AUTH_KAKAO_SECRET }}

      # Google OAuth
      AUTH_GOOGLE_ID: ${{ secrets.AUTH_GOOGLE_ID }}
      AUTH_GOOGLE_SECRET: ${{ secrets.AUTH_GOOGLE_SECRET }}

      # Desktop App Deep Link (Tauri)
      APP_DEEPLINK_SCHEME: ${{ secrets.APP_DEEPLINK_SCHEME }}

      # MySQL
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}

      # AWS S3
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      API_SECRET_KEY: ${{ secrets.API_SECRET_KEY }}

      # PayPal
      SENDBOX_CLIENT_ID: ${{ secrets.SENDBOX_CLIENT_ID }}
      SENDBOX_CLIENT_SECRET: ${{ secrets.SENDBOX_CLIENT_SECRET }}
      NEXT_PUBLIC_PAYPAL_CLIENT_ID: ${{ secrets.SENDBOX_CLIENT_ID }}

      # NicePay
      NICEPAY_CLIENT_ID: ${{ secrets.NICEPAY_CLIENT_ID }}
      NICEPAY_SECRET_KEY: ${{ secrets.NICEPAY_SECRET_KEY }}
      NEXT_PUBLIC_NICEPAY_CLIENT_KEY: ${{ secrets.NICEPAY_CLIENT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install & Build web
        run: |
          pnpm install --frozen-lockfile
          pnpm --filter ./apps/web i18n:check
          pnpm --filter ./apps/web build

      - name: Prepare standalone bundle
        run: |
          rm -rf .deploy-web
          mkdir -p .deploy-web
          cp -R apps/web/.next/standalone/. .deploy-web/
          mkdir -p .deploy-web/apps/web/.next
          cp -R apps/web/.next/static .deploy-web/apps/web/.next/static
          cp -R apps/web/public .deploy-web/apps/web/public

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/callendar.pem
          chmod 600 ~/.ssh/callendar.pem

      - name: Bootstrap remote server (empty Ubuntu supported)
        run: |
          ssh -i ~/.ssh/callendar.pem -o StrictHostKeyChecking=no "${SSH_USER}@${SERVER_HOST}" "DEPLOY_PATH='${DEPLOY_PATH}' bash -s" << 'EOF'
            set -euo pipefail

            APP_DIR="${DEPLOY_PATH:-/home/callendar/apps/api}"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            # Base folders (works even if server is blank)
            mkdir -p "$APP_DIR"

            # Free disk space before any install (avoid ENOSPC)
            rm -rf \
              "$HOME/.npm/_cacache" \
              "$HOME/.npm/_logs" \
              "$APP_DIR/apps/web/.next/cache" \
              "$APP_DIR/web.log" || true
            df -h || true

            # Install Node.js (user-space via nvm) if missing
            if ! command -v node >/dev/null 2>&1; then
              if ! command -v curl >/dev/null 2>&1; then
                echo "ERROR: curl is required on the server for bootstrap." >&2
                exit 1
              fi
              curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
              . "$NVM_DIR/nvm.sh"
              nvm install 20
              nvm alias default 20
            fi

            # Install PM2 if missing (non-fatal on tiny servers)
            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2 || true
            fi
          EOF

      - name: Stream bundle and extract files
        run: |
          tar \
            --exclude='.git' \
            -czf - \
            .deploy-web \
          | ssh -i ~/.ssh/callendar.pem -o StrictHostKeyChecking=no "${SSH_USER}@${SERVER_HOST}" "DEPLOY_PATH='${DEPLOY_PATH}' bash -lc 'set -euo pipefail; APP_DIR=\"\${DEPLOY_PATH:-/home/callendar/apps/api}\"; mkdir -p \"\$APP_DIR\"; cd \"\$APP_DIR\"; rm -rf apps .next node_modules; tar -xzf - -C \"\$APP_DIR\" --strip-components=1'"

      - name: Write env file
        run: |
          ssh -i ~/.ssh/callendar.pem -o StrictHostKeyChecking=no "${SSH_USER}@${SERVER_HOST}" "DEPLOY_PATH='${DEPLOY_PATH}' bash -s" << 'EOF'
            set -euo pipefail

            APP_DIR="${DEPLOY_PATH:-/home/callendar/apps/api}"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            mkdir -p "$APP_DIR"

            mkdir -p "$APP_DIR/apps/web"
            cat > "$APP_DIR/apps/web/.env.production" << 'ENVEOF'
            AUTH_SECRET=${{ secrets.AUTH_SECRET }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            AUTH_KAKAO_ID=${{ secrets.AUTH_KAKAO_ID }}
            AUTH_KAKAO_SECRET=${{ secrets.AUTH_KAKAO_SECRET }}
            AUTH_GOOGLE_ID=${{ secrets.AUTH_GOOGLE_ID }}
            AUTH_GOOGLE_SECRET=${{ secrets.AUTH_GOOGLE_SECRET }}
            APP_DEEPLINK_SCHEME=${{ secrets.APP_DEEPLINK_SCHEME }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
            API_SECRET_KEY=${{ secrets.API_SECRET_KEY }}
            SENDBOX_CLIENT_ID=${{ secrets.SENDBOX_CLIENT_ID }}
            SENDBOX_CLIENT_SECRET=${{ secrets.SENDBOX_CLIENT_SECRET }}
            NEXT_PUBLIC_PAYPAL_CLIENT_ID=${{ secrets.SENDBOX_CLIENT_ID }}
            NICEPAY_CLIENT_ID=${{ secrets.NICEPAY_CLIENT_ID }}
            NICEPAY_SECRET_KEY=${{ secrets.NICEPAY_SECRET_KEY }}
            NEXT_PUBLIC_NICEPAY_CLIENT_KEY=${{ secrets.NICEPAY_CLIENT_ID }}
            NODE_ENV=production
            ENVEOF
          EOF

      - name: Start web server
        run: |
          ssh -i ~/.ssh/callendar.pem -o StrictHostKeyChecking=no "${SSH_USER}@${SERVER_HOST}" "DEPLOY_PATH='${DEPLOY_PATH}' bash -s" << 'EOF'
            set -euo pipefail
            APP_DIR="${DEPLOY_PATH:-/home/callendar/apps/api}"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            if [ -f "$APP_DIR/server.js" ]; then
              ENTRY="$APP_DIR/server.js"
            elif [ -f "$APP_DIR/apps/web/server.js" ]; then
              ENTRY="$APP_DIR/apps/web/server.js"
            else
              echo "ERROR: standalone server.js not found in deploy path" >&2
              ls -la "$APP_DIR" || true
              ls -la "$APP_DIR/apps/web" || true
              exit 1
            fi

            if pm2 describe pecal-web >/dev/null 2>&1; then
              pm2 delete pecal-web || true
            fi

            if command -v pm2 >/dev/null 2>&1; then
              pm2 start "node $ENTRY" --name pecal-web --cwd "$APP_DIR"
              pm2 save || true
            else
              pkill -f "node .*apps/api/server.js" || true
              nohup node "$ENTRY" > "$APP_DIR/web.log" 2>&1 &
            fi
          EOF
